{% extends "base.html" %}
{% block title %}New result for {{game.game_name}} - {{super()}}{% endblock %}
{% block body_class %}game{% endblock %}

{% block content %}
    <script type="application/javascript">
        $(function() {
            let users = {};

            {% for user in users %}
                users["{{user}}"] = { 
                    {% if users[user]["displayName"] %}                
                        "displayName": "{{users[user]["displayName"]}}",
                    {% endif %}
                    {% if users[user]["imageUrl"] %}                
                        "imageUrl": "{{users[user]["imageUrl"]}}"
                    {% endif %}
                };
            {% endfor %}

            $('.player-name').selectize({
                create: true,
                selectOnTab: false,
                render: {
                    option: function(item, escape) {
                        let user = users[item.value];

                        let html =
                            "<div class='option'>" + 
                                (item.value == "-" ? "Select a player" : 
                                (
                                    (user && user["imageUrl"] ? "<img class='user-image' src='" + escape(user["imageUrl"]) + "'>" : "") +
                                    (user && user["displayName"] ? escape(user["displayName"]) : escape(item.value))
                                )) +
                            "</div>";
                        return html;
                    }
                }
            });

            // Fix autocomplete-problem with selectize. See https://github.com/selectize/selectize.js/pull/1363
            document.querySelectorAll('input[type=select-one]').forEach(function(e) { e.setAttribute('autocomplete', 'new-password'); });
        });
    </script>

    <p class="nav">
        <a href="/">Home</a>
        {% if game_name %}
            <a href="/{{game_name}}">Back to game</a>
        {% endif %}
    </p>
    
    <h1>New result for {{game.game_name}}</h1>
    <p>
        Select player names and enter their scores.
    </p>
    <form class="new-result" method="POST" action="new">
        <input type="hidden" name="game" value="{{game_name}}"/>
        {% for n in range(10) %}
            <fieldset>
                <legend>Player {{n + 1}}</legend>
                <label for="player{{n}}">
                    Name:
                </label>
                <select class="player-name" name="player" id="player{{n}}">
                    <option value="">Select a player</option>
                    {% for player in players %}
                        <option value="{{player}}">{{player}}</option>
                    {% endfor %}
                </select>
                {% if game.score_type == 'winnertakesall' %}
                    <label for="score{{n}}">
                        Result:
                    </label>
                    <select name="score" id="score{{n}}">
                        <option value="0">Lost</option>
                        <option value="1">Won</option>
                    </select>
                {% else %}
                    <label for="score{{n}}">
                        Score:
                    </label>
                    <input class="player-score selectize-input" type="number" name="score" id="score{{n}}" autocomplete="off"/>
                {% endif %}
            </fieldset>
        {% endfor %}
        <input type="submit" value="Submit"/>
    </form>
{% endblock %}
